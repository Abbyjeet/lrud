!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):t.Lrud=i()}(this,function(){"use strict";function t(){}function i(t){for(var i=1;i<arguments.length;i++){var e=arguments[i];for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])}return t}function e(){this.nodes={},this.root=null,this.currentFocus=null}t.prototype={on:function(t,i,e){var n=this.e||(this.e={});return(n[t]||(n[t]=[])).push({fn:i,ctx:e}),this},once:function(t,i,e){function n(){r.off(t,n),i.apply(e,arguments)}var r=this;return n._=i,this.on(t,n,e)},emit:function(t){for(var i=[].slice.call(arguments,1),e=((this.e||(this.e={}))[t]||[]).slice(),n=0,r=e.length;n<r;n++)e[n].fn.apply(e[n].ctx,i);return this},off:function(t,i){var e=this.e||(this.e={}),n=e[t],r=[];if(n&&i)for(var s=0,o=n.length;s<o;s++)n[s].fn!==i&&n[s].fn._!==i&&r.push(n[s]);return r.length?e[t]=r:delete e[t],this}};var n=t,r="LEFT",s="RIGHT",o="DOWN",h="ENTER",c={map:{LEFT:r,RIGHT:s,UP:"UP",DOWN:o,ENTER:h},codes:{4:r,21:r,37:r,214:r,205:r,218:r,5:s,22:s,39:s,213:s,206:s,217:s,29460:"UP",19:"UP",38:"UP",211:"UP",203:"UP",215:"UP",29461:o,20:o,40:o,212:o,204:o,216:o,29443:h,13:h,67:h,32:h,23:h,195:h}},d=function(t,i,e){return t===i||t===e},u=function(t){return t&&!!t.orientation};i(e.prototype=Object.create(n.prototype),{register:function(t,i){if(!t)throw new Error("Attempting to register with an invalid id");var e=this._createNode(t,i);if(e.parent){var n=this._createNode(e.parent);-1===n.children.indexOf(t)&&n.children.push(t),this.nodes[e.parent]=n}else this.root=t;this.nodes[t]=e},unregister:function(t){var i=this.nodes[t];if(i){var e=this.nodes[i.parent];e&&(e.children=e.children.filter(function(i){return i!==t}),e.activeChild===t&&(e.activeChild=void 0)),this.currentFocus===t&&(this.blur(),this.currentFocus=void 0),delete this.nodes[t],i.children.forEach(this.unregister.bind(this))}},blur:function(t){var i=this.nodes[t]||this.nodes[this.currentFocus];i&&this.emit("blur",i.id)},focus:function(t){var i=this.nodes[t]||this.nodes[this.currentFocus]||this.nodes[this.root];if(i){var e=i.activeChild||i.children[0];if(e)return this.focus(e);this.blur(),this.currentFocus=i.id,this.emit("focus",this.currentFocus),this._bubbleActive(this.currentFocus)}},handleKeyEvent:function(t){this._bubbleKeyEvent(t,this.currentFocus)},destroy:function(){this.e={},this.nodes={},this.root=null,this.currentFocus=null},setActiveChild:function(t,i){var e=this.nodes[t];e&&-1!==e.children.indexOf(i)&&e.activeChild!==i&&(e.activeChild&&this.emit("inactive",e.activeChild),this.emit("active",i),e.activeChild=i)},setActiveIndex:function(t,i){var e=this.nodes[t];e&&e.children[i]&&this.setActiveChild(t,e.children[i])},_createNode:function(t,e){return i({id:t,children:[]},this.nodes[t]||{},e||{})},_findChild:function(t,i){if(t){var e=t.activeChild||t.children[0],n=this.nodes[e];return n&&!i(n)?this._findChild(n,i):n}},_updateGrid:function(t){var i=this._findChild(t,u);if(i){var e=i.activeChild||i.children[0],n=i.children.indexOf(e);t.children.forEach(function(t){var i=this.nodes[t],e=u(i)?i:this._findChild(i,u);e&&this.setActiveIndex(e.id,Math.min(e.children.length-1,n))}.bind(this))}},_bubbleKeyEvent:function(t,i){var n=this.nodes[i];if(n){var r=e.KEY_CODES[t.keyCode];if(r===e.KEY_MAP.ENTER)return this.emit("select",i);if(function(t,i){return"horizontal"===i.orientation&&d(e.KEY_CODES[t.keyCode],e.KEY_MAP.LEFT,e.KEY_MAP.RIGHT)||"vertical"===i.orientation&&d(e.KEY_CODES[t.keyCode],e.KEY_MAP.UP,e.KEY_MAP.DOWN)}(t,n)){var s=n.activeChild||n.children[0],o=n.children.indexOf(s),h=d(r,e.KEY_MAP.RIGHT,e.KEY_MAP.DOWN)?1:-1,c=o+h,u=n.children.length,l=n.wrapping?(c+u)%u:c,f=n.children[l];if(f)return n.grid&&this._updateGrid(n),this.emit("move",{id:i,offset:h,orientation:n.orientation,enter:{id:f,index:l},leave:{id:s,index:o}}),this.focus(f),t.stopPropagation()}this._bubbleKeyEvent(t,n.parent)}},_bubbleActive:function(t){var i=this.nodes[t];i.parent&&(this.setActiveChild(i.parent,t),this._bubbleActive(i.parent))}}),e.KEY_MAP=c.map,e.KEY_CODES=c.codes;return e});