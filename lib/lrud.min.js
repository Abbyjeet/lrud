!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Lrud=e()}(this,function(){"use strict";function t(){}function e(){this.nodes={},this.currentFocus=null}t.prototype={on:function(t,e,i){var n=this.e||(this.e={});return(n[t]||(n[t]=[])).push({fn:e,ctx:i}),this},once:function(t,e,i){function n(){r.off(t,n),e.apply(i,arguments)}var r=this;return n._=e,this.on(t,n,i)},emit:function(t){for(var e=[].slice.call(arguments,1),i=((this.e||(this.e={}))[t]||[]).slice(),n=0,r=i.length;n<r;n++)i[n].fn.apply(i[n].ctx,e);return this},off:function(t,e){var i=this.e||(this.e={}),n=i[t],r=[];if(n&&e)for(var o=0,s=n.length;o<s;o++)n[o].fn!==e&&n[o].fn._!==e&&r.push(n[o]);return r.length?i[t]=r:delete i[t],this}};var i=t;return e.prototype=Object.create(i.prototype),e.prototype.register=function(t,e){if(e=e||{},!t)throw new Error("Attempting to register with an invalid id");var i=this._createNode(t,e);if(i.parent){var n=this._createNode(i.parent);-1===n.children.indexOf(t)&&n.children.push(t),this.nodes[i.parent]=n}this.nodes[t]=i},e.prototype.unregister=function(t){var e=this.nodes[t];if(e){var i=this.nodes[e.parent];i&&(i.children=i.children.filter(function(e){return e!==t}),i.activeChild===t&&(i.activeChild=void 0)),this.currentFocus===t&&(this.blur(t),this.currentFocus=void 0),delete this.nodes[t],e.children.forEach(this.unregister.bind(this))}},e.prototype.blur=function(t){t=t||this.currentFocus;this.nodes[t]&&this.emit("blur",t)},e.prototype.focus=function(t){t=t||this.currentFocus;var e=this.nodes[t];if(e){var i=e.activeChild||e.children[0];if(i)return this.focus(i);this.blur(),this.currentFocus=t,this.emit("focus",t),this._bubbleActive(t)}},e.prototype.handleKeyEvent=function(t){this._bubbleKeyEvent(t,this.currentFocus)},e.prototype.destroy=function(){this.e={},this.nodes={},this.currentFocus=null},e.prototype._isValidLRUDEvent=function(t,i){var n=t.keyCode;return"horizontal"===i.orientation&&(e.KEY_CODES[n]===e.KEY_MAP.LEFT||e.KEY_CODES[n]===e.KEY_MAP.RIGHT)||"vertical"===i.orientation&&(e.KEY_CODES[n]===e.KEY_MAP.UP||e.KEY_CODES[n]===e.KEY_MAP.DOWN)},e.prototype._createNode=function(t,e){return function(){for(var t={},e=0;e<arguments.length;e++){var i=arguments[e];for(var n in i)i.hasOwnProperty(n)&&(t[n]=i[n])}return t}({children:[]},this.nodes[t]||{},e||{})},e.prototype._getNextActiveIndex=function(t,e,i){var n=e+i,r=t.children.length;return t.wrapping&&-1===n?r-1:t.wrapping&&n===r?0:n},e.prototype._getEventOffset=function(t){return e.KEY_CODES[t.keyCode]===e.KEY_MAP.RIGHT||e.KEY_CODES[t.keyCode]===e.KEY_MAP.DOWN?1:-1},e.prototype._updateGrid=function(t){var e=this,i=t.activeChild||t.children[0],n=this.nodes[i],r=n.activeChild||n.children[0];if(r){var o=n.children.indexOf(r);t.children.forEach(function(t){var i=e.nodes[t];e._setActiveChild(t,i.children[o]||i.activeChild)})}},e.prototype._bubbleKeyEvent=function(t,i){var n=this.nodes[i];if(n){if(e.KEY_CODES[t.keyCode]===e.KEY_MAP.ENTER)return this.emit("select",i);if(this._isValidLRUDEvent(t,n)){var r=n.activeChild||n.children[0],o=n.children.indexOf(r),s=this._getEventOffset(t),h=this._getNextActiveIndex(n,o,s),c=n.children[h];if(c)return n.grid&&this._updateGrid(n),this.emit("move",{id:i,offset:s,enter:{id:c,index:h},leave:{id:r,index:o}}),this.focus(c),t.stopPropagation()}this._bubbleKeyEvent(t,n.parent)}},e.prototype._setActiveChild=function(t,e){var i=this.nodes[t].activeChild;i!==e&&(i&&this.emit("inactive",i),this.emit("active",e),this.nodes[t].activeChild=e)},e.prototype._bubbleActive=function(t){var e=this.nodes[t];e.parent&&(this._setActiveChild(e.parent,t),this._bubbleActive(e.parent))},e.KEY_CODES={37:"LEFT",39:"RIGHT",38:"UP",40:"DOWN",13:"ENTER"},e.KEY_MAP={LEFT:"LEFT",RIGHT:"RIGHT",UP:"UP",DOWN:"DOWN",ENTER:"ENTER"},e});